import struct,time,codecs
import getcode

def xstr2byte(thestr):
    aa=[ord(c) for c in thestr]
    #print(aa)
    return struct.pack(str(len(aa))+'B',*aa)

def str2xstr(str_chg):
    ss=''
    str_chg_b=str_chg.encode('utf-8')
    for pp in struct.unpack(str(len(str_chg_b))+'B',str_chg_b):
        ss=ss+hex(pp)
    xstr=codecs.decode(ss.replace('0x',r'\x'), "unicode_escape")#整理成\x形式
    #print(xstr2byte(xstr).decode('utf-8'))
    return xstr

def makedata(pk00,pk01,perid,name,showtime,url,title0=None,title1=None):
   

    #(pk00,pk01,sn,perid,name,dcname,sn_dk,showtime,url)


    #home无照片
    #title1=b'\x08\x08\x12\x21\x38\x34\x45\x30\x46\x34\x32\x36\x35\x30\x45\x31\x31\x35\x30\x31\x31\x36\x33\x30\x31\x35\x33\x30\x35\x38\x38\x34\x31\x30\x30\x36\x32\x18\x99\xd4\xc6\xe5\xb8\x2f\x62\x8d\x03\x12\x01\x30\x18\x99\xd4\xc6\xe5\xb8\x2f\x20\xeb\xb6\xd6\xaf\x98\xfe\x03\x2a\x10\x38\x34\x45\x30\x46\x34\x32\x36\x35\x30\x45\x31\x31\x35\x30\x31\x38\x01\x4a\xe4\x02\x08\x01\x10\xca\xd1\xc6\xe5\xb8\x2f\x18\xf2\xc4\x2c\x2a\xd2\x02\x7b\x22\x61\x64\x6d\x69\x6e\x49\x64\x22\x3a\x22\x31\x37\x35\x33\x30\x30\x30\x30\x31\x30\x37\x32\x33\x36\x22\x2c\x22\x61\x64\x6d\x69\x6e\x4e\x61\x6d\x65\x22\x3a\x22\xe9\x83\xad\xe5\x8f\xaf\x22\x2c\x22\x61\x6c\x69\x76\x65\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x63\x61\x72\x64\x4e\x6f\x22\x3a\x22\x22\x2c\x22\x64\x65\x76\x69\x63\x65\x49\x70\x22\x3a\x22\x22\x2c\x22\x64\x65\x76\x69\x63\x65\x4e\x61\x6d\x65\x22\x3a\x22\x55\x46\x61\x63\x65\x35\xe7\xb3\xbb\xe8\x80\x83\xe5\x8b\xa4\xe6\x9c\xba\x22\x2c\x22\x64\x65\x76\x69\x63\x65\x4e\x6f\x22\x3a\x22\x38\x34\x45\x30\x46\x34\x32\x36\x35\x30\x45\x31\x31\x35\x30\x31\x22\x2c\x22\x64\x65\x76\x69\x63\x65\x56\x65\x72\x73\x69\x6f\x6e\x22\x3a\x22\x47\x44\x2d\x56\x35\x2e\x32\x30\x31\x35\x22\x2c\x22\x65\x76\x65\x6e\x74\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x70\x61\x73\x73\x54\x69\x6d\x65\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x70\x65\x72\x6d\x69\x73\x73\x69\x6f\x6e\x54\x69\x6d\x65\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x72\x65\x63\x4d\x6f\x64\x65\x22\x3a\x22\x31\x22\x2c\x22\x72\x65\x63\x4d\x6f\x64\x65\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x72\x65\x63\x53\x63\x6f\x72\x65\x22\x3a\x31\x30\x30\x2c\x22\x72\x65\x63\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x72\x65\x73\x75\x6c\x74\x22\x3a\x31\x2c\x22\x73\x68\x6f\x77\x54\x69\x6d\x65\x22\x3a\x31\x36\x33\x30\x31\x35\x33\x30\x35\x38\x35\x30\x36\x2c\x22\x74\x79\x70\x65\x22\x3a\x31\x7d\x32\x00'
    # I4 SN号16 时间戳13 小包号4 未知数30  SN号16 未知数21 不改信息315 时间戳13 未知数12（tuple格式）

    #园区小包
    #title1='\x08\x08\x12\x21\x38\x34\x45\x30\x46\x34\x32\x38\x36\x37\x42\x38\x35\x32\x37\x41\x31\x36\x33\x30\x33\x38\x38\x38\x35\x39\x32\x39\x35\x33\x38\x35\x33\x18\x9f\xe3\xfe\xd5\xb9\x2f\x62\x85\x04\x12\x01\x30\x18\x9f\xe3\xfe\xd5\xb9\x2f\x20\xc4\xb2\xd6\xaf\x98\xfe\x03\x2a\x10\x38\x34\x45\x30\x46\x34\x32\x38\x36\x37\x42\x38\x35\x32\x37\x41\x38\x01\x4a\xdc\x03\x08\x01\x10\xb9\xf5\xfd\xd5\xb9\x2f\x18\xb2\xc6\xb9\x12\x2a\xd8\x02\x7b\x22\x61\x64\x6d\x69\x6e\x49\x64\x22\x3a\x22\x31\x37\x35\x33\x30\x30\x30\x30\x30\x35\x31\x34\x31\x36\x22\x2c\x22\x61\x64\x6d\x69\x6e\x4e\x61\x6d\x65\x22\x3a\x22\xe5\x88\x98\xe4\xbd\xb3\xe6\xac\xa3\x22\x2c\x22\x61\x6c\x69\x76\x65\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x63\x61\x72\x64\x4e\x6f\x22\x3a\x22\x22\x2c\x22\x64\x65\x76\x69\x63\x65\x49\x70\x22\x3a\x22\x31\x39\x32\x2e\x31\x36\x38\x2e\x31\x36\x2e\x31\x30\x22\x2c\x22\x64\x65\x76\x69\x63\x65\x4e\x61\x6d\x65\x22\x3a\x22\xe5\x88\x9b\xe4\xb8\x9a\xe5\x9b\xad\x22\x2c\x22\x64\x65\x76\x69\x63\x65\x4e\x6f\x22\x3a\x22\x38\x34\x45\x30\x46\x34\x32\x38\x36\x37\x42\x38\x35\x32\x37\x41\x22\x2c\x22\x64\x65\x76\x69\x63\x65\x56\x65\x72\x73\x69\x6f\x6e\x22\x3a\x22\x47\x44\x2d\x56\x35\x2e\x32\x30\x31\x35\x22\x2c\x22\x65\x76\x65\x6e\x74\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x70\x61\x73\x73\x54\x69\x6d\x65\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x70\x65\x72\x6d\x69\x73\x73\x69\x6f\x6e\x54\x69\x6d\x65\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x72\x65\x63\x4d\x6f\x64\x65\x22\x3a\x22\x31\x22\x2c\x22\x72\x65\x63\x4d\x6f\x64\x65\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x72\x65\x63\x53\x63\x6f\x72\x65\x22\x3a\x38\x39\x2c\x22\x72\x65\x63\x54\x79\x70\x65\x22\x3a\x31\x2c\x22\x72\x65\x73\x75\x6c\x74\x22\x3a\x31\x2c\x22\x73\x68\x6f\x77\x54\x69\x6d\x65\x22\x3a\x31\x36\x33\x30\x33\x38\x38\x38\x34\x35\x32\x34\x31\x2c\x22\x74\x79\x70\x65\x22\x3a\x31\x7d\x32\x71\x10\x01\x2a\x6d\x0a\x02\x41\x31\x12\x02\x4e\x4f\x2a\x63\x68\x74\x74\x70\x73\x3a\x2f\x2f\x75\x6e\x69\x75\x62\x69\x2d\x61\x69\x6f\x74\x2e\x6f\x73\x73\x2d\x63\x6e\x2d\x68\x61\x6e\x67\x7a\x68\x6f\x75\x2e\x61\x6c\x69\x79\x75\x6e\x63\x73\x2e\x63\x6f\x6d\x2f\x64\x65\x76\x69\x63\x65\x2f\x38\x34\x45\x30\x46\x34\x32\x38\x36\x37\x42\x38\x35\x32\x37\x41\x2f\x32\x30\x32\x31\x30\x38\x33\x31\x31\x33\x34\x37\x32\x35\x5f\x33\x30\x38\x5f\x72\x67\x62\x2e\x6a\x70\x67'
    
    #newdata0=b'\x00\x00'+struct.pack('H',pk00) +struct.pack('!I',len(title1)) #根据小包生成大包数据

    #解包(小包)小包号一定要改，是连贯的
    #b=struct.unpack('4s16s13s4s30s16s21s315s13s12s',title1) #home无照片

    #fmt='4s16s13s4s30s16s34s14s15s9s40s13s16s9s14s16s163s13s34s91s' #园区有照片
    #4s	16s(sn)13s(time)4s(num)30s(unknow)16s(sn)34s(BfID)14s(PID)15s(BfNam)9s(Nam)40s(BfIP)13s(IP)16s(BfDcNam)9s(DcName)14s(Bfsn)16s(sn)163s(Bftime)13s(time)34s(Bfurl)91s(url)
    #0  1       2       3       4           5       6       7       8           9       10      11      12          13      14      15      16          17      18          19
    

    #改包(小包)
    t = time.time()#生成时间戳
    nowtime=str(round(t * 1000))    
    title2=title1.replace(title1[20:33],str2xstr(nowtime)) #改了时间

    #小包初始号
    pk01_str=str(pk01)
    if len(str(pk01))==1:
        pk01_str='000'+pk01_str
    elif len(str(pk01))==2:
        pk01_str='00'+pk01_str
    elif len(str(pk01))==3:
        pk01_str='0'+pk01_str        
    title3=title2.replace(title1[33:37],str2xstr(pk01_str)) #改包号

    #改sn
    #title4=title3.replace(title1[4:20],str2xstr(sn))

    #改id
    title5=title3.replace(title1[117:131],str2xstr(perid)) #改id

    #改name
    title6=title5.replace(title1[146:155],str2xstr(name)) #改name
    

    #改showtime
    title7=title6.replace(title1[-138:-125],str2xstr(showtime)) #改showtime

    #改url
    title8=title7.replace(title1[-91:],str2xstr(url)) #改url

    #改dcname
    #title9=title8.replace(title1[224:233],str2xstr(dcname))

    
    #重新封装(小包)
    newdata1=xstr2byte(title8)

    #封装大包数据
    newdata0=xstr2byte(title0[0:2])+struct.pack('H',pk00) +struct.pack('!I',len(title8)) #根据小包生成大包数据


    pk00=pk00+1
    pk01=pk01+1
    return  newdata0,newdata1,pk00,pk01

if __name__ == '__main__':
    pk00=51
    pk01=51
    
    #perid='17530000051164'
    #name='郭可'
    name='刘圣豪'
    #perid='17530000107236'#家里刘圣豪
    perid='17530000051164'#单位刘圣豪
    showtime='1630240790000'    
    url='uniubi-aiot.oss-cn-hangzhou.aliyuncs.com/device/84E0F42867B8527A/20210831134504_803_rgb.jpg'
    #title0,title1=getcode.read_card()
    #card0,card1=getcode.read_card("./data/card_home.txt")
    #card0,card1=getcode.read_card("./data/card_left.txt")
    card0,card1=getcode.read_card("./data/card_right.txt")
    #card0,card1=getcode.read_card("./data/card_yq.txt")
    newdata0,newdata1,heart00,heart01=makedata(pk00=pk00,pk01=pk01,perid=perid,name=name,showtime=showtime,url=url,title0=card0,title1=card1)
    print(newdata0)
    print(newdata1)
